---
- name: Deploy sample flask app to k3s
  hosts: k3s
  become: true
  vars:
    app_namespace: "{{ lookup('env', 'APP_NAMESPACE') | default('myflask', true) }}"
    app_name: "{{ lookup('env', 'APP_NAME') | default('myflask', true) }}"
    image_ref: "{{ lookup('env', 'IMAGE_REF') | default('', true) }}"
    domain: "{{ lookup('env', 'DOMAIN') | default('', true) }}"
    letsencrypt_email: "{{ lookup('env', 'LETSENCRYPT_EMAIL') | default('', true) }}"
    tls_secret_name: "{{ lookup('env', 'TLS_SECRET_NAME') | default('myflask-tls', true) }}"
    cert_manager_version: "{{ lookup('env', 'CERT_MANAGER_VERSION') | default('v1.16.3', true) }}"
  tasks:
    - name: Validate required vars
      ansible.builtin.assert:
        that:
          - image_ref | length > 0
          - domain | length > 0
          - letsencrypt_email | length > 0
        fail_msg: "Set IMAGE_REF, DOMAIN, LETSENCRYPT_EMAIL as environment variables."

    - name: Install curl
      ansible.builtin.apt:
        name: curl
        state: present
        update_cache: true

    - name: Install k3s if not installed
      ansible.builtin.shell: |
        curl -sfL https://get.k3s.io | sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for kubectl API access
      ansible.builtin.shell: kubectl get ns kube-system
      register: kubectl_ready
      retries: 12
      delay: 5
      until: kubectl_ready.rc == 0
      changed_when: false

    - name: Ensure namespace exists
      ansible.builtin.shell: |
        kubectl create namespace {{ app_namespace }} --dry-run=client -o yaml | kubectl apply -f -

    - name: Install cert-manager
      ansible.builtin.shell: |
        kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/{{ cert_manager_version }}/cert-manager.yaml

    - name: Wait for cert-manager rollout
      ansible.builtin.shell: kubectl -n cert-manager rollout status deployment/{{ item }} --timeout=180s
      loop:
        - cert-manager
        - cert-manager-webhook
        - cert-manager-cainjector
      changed_when: false

    - name: Apply Let's Encrypt ClusterIssuer
      ansible.builtin.shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: cert-manager.io/v1
        kind: ClusterIssuer
        metadata:
          name: letsencrypt-prod
        spec:
          acme:
            email: {{ letsencrypt_email }}
            server: https://acme-v02.api.letsencrypt.org/directory
            privateKeySecretRef:
              name: letsencrypt-prod-account-key
            solvers:
              - http01:
                  ingress:
                    class: traefik
        EOF

    - name: Deploy app manifest
      ansible.builtin.shell: |
        cat <<EOF | kubectl apply -n {{ app_namespace }} -f -
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: {{ app_name }}
          labels:
            app.kubernetes.io/name: {{ app_name }}
        spec:
          replicas: 1
          selector:
            matchLabels:
              app.kubernetes.io/name: {{ app_name }}
          template:
            metadata:
              labels:
                app.kubernetes.io/name: {{ app_name }}
            spec:
              containers:
              - name: {{ app_name }}
                image: {{ image_ref }}
                imagePullPolicy: Always
                ports:
                - containerPort: 5000
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: {{ app_name }}
        spec:
          selector:
            app.kubernetes.io/name: {{ app_name }}
          ports:
          - port: 80
            targetPort: 5000
        ---
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: {{ app_name }}
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
            traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
        spec:
          ingressClassName: traefik
          tls:
          - hosts:
            - {{ domain }}
            secretName: {{ tls_secret_name }}
          rules:
          - host: {{ domain }}
            http:
              paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: {{ app_name }}
                    port:
                      number: 80
        EOF

    - name: Wait for app deployment rollout
      ansible.builtin.shell: kubectl -n {{ app_namespace }} rollout status deployment/{{ app_name }} --timeout=180s
      changed_when: false

    - name: Wait for TLS secret issued by cert-manager
      ansible.builtin.shell: kubectl -n {{ app_namespace }} get secret {{ tls_secret_name }} -o name
      register: cert_ready
      retries: 30
      delay: 10
      until: cert_ready.rc == 0
      failed_when: false
      changed_when: false

    - name: Show deploy resources
      ansible.builtin.shell: kubectl -n {{ app_namespace }} get deploy,svc,ingress,certificates,secrets,pods -o wide
      register: deploy_status
      changed_when: false

    - name: Print resource status
      ansible.builtin.debug:
        var: deploy_status.stdout_lines

    - name: Print certificate wait result
      ansible.builtin.debug:
        var: cert_ready.stdout_lines
