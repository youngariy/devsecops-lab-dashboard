name: Dashboard Sync on Workflow Completion

on:
  workflow_run:
    workflows:
      - CD Build, Push & Deploy to GCE
    types:
      - completed

jobs:
  sync-dashboard:
    if: ${{ github.event.workflow_run.head_branch == 'main' && github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger dashboard sync
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
          SYNC_TOKEN: ${{ secrets.SYNC_TOKEN }}
        run: |
          set -euo pipefail
          SYNC_URL="https://${DOMAIN}/api/pipelines/sync?per_page=50"
          ok=0
          for i in {1..8}; do
            if curl -sSf -m 15 -X POST \
              -H "X-Sync-Token: ${SYNC_TOKEN}" \
              "${SYNC_URL}" >/tmp/sync-response.json; then
              echo "Sync OK: ${SYNC_URL}"
              cat /tmp/sync-response.json
              ok=1
              break
            fi
            echo "...retry sync (${i}/8): ${SYNC_URL}"
            sleep 10
          done
          if [ "$ok" -ne 1 ]; then
            echo "Sync failed: ${SYNC_URL}"
            exit 1
          fi
