name: Security - DAST (ZAP after CD)

on:
  workflow_run:
    workflows: ["CD Build, Push & Deploy to GCE"]
    types: [completed]
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1" # every Monday 08:00 UTC

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  zap_scan:
    if: >
      github.event_name != 'workflow_run' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')

    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      actions: write

    env:
      TARGET: https://${{ secrets.DOMAIN }}
      SCAN_MINUTES: "5"
      USE_ALPHA: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure TARGET is set
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${TARGET:-}" ]]; then
            echo "ERROR: secrets.DOMAIN is empty (TARGET is empty)" >&2
            exit 1
          fi
          echo "Target: ${TARGET}"

      - name: Prepare ZAP rules.tsv (tabs)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .zap
          : > .zap/rules.tsv

      - name: Loosen workspace perms (container write)
        run: sudo chmod -R a+rwx .

      - name: Wait until HTTPS is up
        shell: bash
        run: |
          set -euo pipefail
          for i in $(seq 1 24); do
            if curl -fsS --max-time 5 "${TARGET}" >/dev/null; then
              echo "HTTPS OK"
              exit 0
            fi
            echo "Waiting HTTPS ($i/24)"
            sleep 5
          done
          echo "ERROR: target is not ready" >&2
          exit 1

      - name: Run ZAP Baseline (docker)
        timeout-minutes: 20
        shell: bash
        run: |
          set -euo pipefail
          docker pull ghcr.io/zaproxy/zaproxy:stable

          A_FLAG=""
          if [ "${USE_ALPHA}" = "1" ]; then
            A_FLAG="-a"
          fi

          set +e
          docker run --rm --network=host \
            -v "$PWD:/zap/wrk" \
            -e ZAP_AUTH_HEADER="${{ secrets.ZAP_AUTH_HEADER }}" \
            -e ZAP_AUTH_HEADER_VALUE="${{ secrets.ZAP_AUTH_HEADER_VALUE }}" \
            -e ZAP_AUTH_HEADER_SITE="${{ secrets.ZAP_AUTH_HEADER_SITE }}" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t "${TARGET}" \
              -m "${SCAN_MINUTES}" \
              ${A_FLAG} \
              -c .zap/rules.tsv \
              -J report_json.json \
              -w report_md.md \
              -r report_html.html
          rc=$?
          set -e

          if [ "$rc" -eq 0 ]; then
            echo "ZAP: no alerts. (exit 0)"
          elif [ "$rc" -eq 2 ]; then
            echo "ZAP: WARN-only (exit 2). Proceeding."
          else
            echo "ZAP: failed with exit code $rc"
            exit "$rc"
          fi

      - name: Append summary (Markdown)
        shell: bash
        run: |
          {
            echo "## ZAP Baseline Report"
            echo
            if [ -s report_md.md ]; then
              sed 's/^/    /' report_md.md
            else
              echo "_No markdown report generated._"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload ZAP reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-${{ github.run_id }}
          path: |
            report_json.json
            report_html.html
            report_md.md
          retention-days: 14
