services:
  api:
    build:
      context: ../../apps/api
      dockerfile: Dockerfile
    expose:
      - "5000"
    environment:
      - FLASK_ENV=development

  web:
    build:
      context: ../../apps/web
      dockerfile: Dockerfile
    expose:
      - "3000"
    environment:
      - API_BASE=http://api:5000
    depends_on:
      - api

  nginx:
    image: nginx:alpine
    depends_on:
      - api
      - web
    ports:
      - "8080:80"
    environment:
      DOMAIN: localhost
    volumes:
      - ../nginx/default.http.conf.template:/etc/nginx/templates/default.conf.template:ro
    entrypoint:
      - sh
      - -exc
      - |
        envsubst '$DOMAIN' < /etc/nginx/templates/default.conf.template \
          > /etc/nginx/conf.d/default.conf
        exec nginx -g 'daemon off;'
